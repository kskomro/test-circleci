version: 2.1

orbs:
  gh: circleci/github-cli@2.0

#####################################################
# Parameters
#####################################################
parameters:
  sources-changed:
    type: boolean
    default: false

#####################################################
# Workflows
#####################################################
jobs:
  my-job:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run: git checkout -b feature/autogenerated
      - run: cp -f test.txt test-copy.txt
      - run: git config user.email "bot@example.com"
      - run: git config user.name "CircleCI Bot"
      - run: git add test-copy.txt
      - run: git commit -am "make a copy of test.txt"
      - run: git push origin feature/autogenerated
      - run:
          command: |
            gh pr create --title "Autogenerated copy of test.txt"
          name: Create Pull Request
      - run:
          command: |
            cd ..
            rm -rf test-circleci
          name: Remove repo

workflows:
  version: 2
  my-workflow:
    when:
      and:
        - equal: [ main, << pipeline.git.branch >> ]
        - equal: [ true, << pipeline.parameters.sources-changed >> ]
    jobs:
      - my-job:
          context:
            - GITHUB_TOKEN