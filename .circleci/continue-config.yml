version: 2.1

orbs:
  gh: circleci/github-cli@2.0

#####################################################
# Parameters
#####################################################
parameters:
  sources-changed:
    type: boolean
    default: false

#####################################################
# Workflows
#####################################################
jobs:
  my-job:
    docker:
      - image: cimg/base:stable
    steps:
      - gh/setup:
          token: GITHUB_TOKEN
      - checkout
      - run:
          command: |
            COMMIT_SHA=$(git rev-parse origin/main)
            git checkout -b feature/autogenerated-$COMMIT_SHA
            cp -f test.txt test-copy.txt
            git config user.email "bot@example.com"
            git config user.name "CircleCI Bot"
            git add test-copy.txt
            git commit -am "make a copy of test.txt"
            git push origin feature/autogenerated-$COMMIT_SHA
          name: Create branch with copy 
      - run:
          command: |
            gh pr create --fill --title "Autogenerated copy of test.txt"
          name: Create Pull Request
      - run:
          command: |
            cd ..
            rm -rf test-circleci
          name: Remove repo

workflows:
  version: 2
  my-workflow:
    when:
      and:
        - equal: [ main, << pipeline.git.branch >> ]
        - equal: [ true, << pipeline.parameters.sources-changed >> ]
    jobs:
      - my-job:
          context:
            - GITHUB_TOKEN