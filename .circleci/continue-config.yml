version: 2.1

orbs:
  gh: circleci/github-cli@2.0

#####################################################
# Parameters
#####################################################
parameters:
  sources-changed:
    type: boolean
    default: false

#####################################################
# Workflows
#####################################################
jobs:
  my-job:
    docker:
      - image: cimg/base:stable
    steps:
      - gh/setup:
          token: GITHUB_TOKEN
      - run:
          command: |
            git clone git@github.com:kskomro/test-circleci.git
            cd test-circleci
          name: Setup repo
      - run: git checkout -b feature/autogenerated
      - run: cp -f test.txt test-copy.txt
      - run: git commit -am "make a copy of test.txt"
      - run: git push origin feature/autogenerated
      - run:
          command: |
            gh pr create --title "Autogenerated copy of test.txt"
          name: Create Pull Request
      - run:
          command: |
            cd ..
            rm -rf test-circleci
          name: Remove repo

  echo-token:
    docker:
      - image: cimg/base:stable
    steps:
      - run: echo $GITHUB_TOKEN

workflows:
  version: 2
  test-token:
    jobs:
      - echo-token:
          context:
            - GITHUB_TOKEN
  my-workflow:
    when:
      and:
        - equal: [ main, << pipeline.git.branch >> ]
        - equal: [ true, << pipeline.parameters.sources-changed >> ]
    jobs:
      - my-job:
          context:
            - GITHUB_TOKEN